# wink-mqtt

Enable local-control of Rooted Wink Hub running 3.x firmware with MQTT. Integrates nicely with Home Assistant MQTT lights, switches, sensors, etc. https://home-assistant.io/

## Installation

The Wink Hub firmware includes NodeJS, but not npm. You will need to do *one* of the following:
  * run `npm install` on a machine with npm and then copy the files to the Wink with SSH:

  ```
  $ git clone https://github.com/danielolson13/wink-mqtt.git
  $ cd wink-mqtt
  $ npm install
  $ scp -r . root@<wink-hub-ip-address>:/opt/wink-mqtt
  ```

  * install from a tarball:

  ```
  [root@flex-dvt ~]# curl -skL https://github.com/danielolson13/wink-mqtt/releases/download/v0.1.0/wink-mqtt-0.1.0.tgz | tar -zxvf - -C /opt
  [root@flex-dvt ~]# mv /opt/package /opt/wink-mqtt
  ```

To have wink-mqtt run at start up, run the installer:

```
[root@flex-dvt ~]# /opt/wink-mqtt/install.sh
```

## Configuration
wink-mqtt looks for a `/opt/wink-mqtt/.wink-mqttrc` config file, which is auto-generated by `install.sh`. It may export the following environment variables (default values shown):

```bash
# The MQTT server URL
export MQTT_SERVER="mqtt://localhost"
# A topic prefix for all wink hub mqtt devices
export WINK_MQTT_TOPIC_BASE="home"
# The full path to `aprontest` command
export WINK_MQTT_APRON_BIN="/usr/sbin/aprontest"
# The number of milliseconds to wait for `aprontest` to complete
export WINK_MQTT_APRON_TIMEOUT="10000"
# The delay between calls to `aprontest` when syncing all devices
export WINK_MQTT_DELAY="100"
# A debounce delay to prevent multiple `aprontest` queries per device
export WINK_MQTT_DEBOUNCE="1000"
```

## How do I root the Wink Hub?
Matt Carrier has a good article on rooting and getting SSH access to the Wink Hub with the UART method https://mattcarrier.com/post/hacking-the-winkhub-part-1/
https://www.exploitee.rs/index.php/Wink_Hub%E2%80%8B%E2%80%8B

## How wink-mqtt works
wink-mqtt uses the `aprontest` binary on the Wink Hub to communicate with the Z-Wave, Zigbee and Lutron radios. Each paired device is given a MasterID. wink-hub subscribes to an MQTT server for `set` events. Topics are organized by `home/<masterid>/<attribute>/set`

```
$ mosquitto_pub -t 'home/20/3/set' -v 'TRUE'
```

To view MasterID and attributes you can run `aprontest -l` then `aprontest -l -m 20`.

wink-mqtt receives device status changes from rsyslogd and then queries the apron database via `aprontest` for the current values of the devices. Those updates are then published back to the MQTT topic `home/<masterid>/<attribute>` with their current values.

## Why the Wink Hub?
It's cheap, rootable and has Z-Wave, Zigbee, Lutron, Wifi and Bluetooth radios.

Please feel free to contribute, this is working but by no means a perfect solution.
